<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Sistema de Detec√ß√£o Facial</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #00ff00;
            text-align: center;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .debug-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .video-section {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 20px;
        }
        
        #video-container {
            position: relative;
            display: inline-block;
            background-color: #000;
            border: 2px solid #00ff00;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .debug-panel {
            background-color: #2a2a2a;
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
        }
        
        .debug-panel h3 {
            margin-top: 0;
            color: #ffff00;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 5px;
        }
        
        .status-item {
            margin: 8px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .status-ok {
            background-color: #004400;
            color: #00ff00;
        }
        
        .status-error {
            background-color: #440000;
            color: #ff0000;
        }
        
        .status-warning {
            background-color: #444400;
            color: #ffff00;
        }
        
        .log-panel {
            grid-column: 1 / -1;
            background-color: #000;
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 2px 0;
        }
        
        .log-info { color: #00ff00; }
        .log-warn { color: #ffff00; }
        .log-error { color: #ff0000; }
        .log-success { color: #00ffff; }
        
        canvas {
            max-width: 100%;
            height: auto;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        
        .stat-box {
            background-color: #2a2a2a;
            border: 1px solid #00ff00;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DEBUG - Sistema de Detec√ß√£o Facial</h1>
        
        <div class="video-section">
            <div id="video-container"></div>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="detection-count">0</div>
                    <div class="stat-label">Detec√ß√µes</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="face-count">0</div>
                    <div class="stat-label">Faces Encontradas</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="fps-count">0</div>
                    <div class="stat-label">FPS Detec√ß√£o</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="error-count">0</div>
                    <div class="stat-label">Erros</div>
                </div>
            </div>
        </div>
        
        <div class="debug-grid">
            <div class="debug-panel">
                <h3>üîß Status do Sistema</h3>
                <div id="system-status">
                    <div class="status-item status-warning">Inicializando...</div>
                </div>
            </div>
            
            <div class="debug-panel">
                <h3>üìä Informa√ß√µes T√©cnicas</h3>
                <div id="tech-info">
                    <div>Aguardando dados...</div>
                </div>
            </div>
        </div>
        
        <div class="log-panel">
            <h3>üìù Log em Tempo Real</h3>
            <div id="log-output"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="jsmpeg.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script>
        // Sistema de debug
        let debugStats = {
            detectionCount: 0,
            faceCount: 0,
            errorCount: 0,
            lastDetectionTime: 0,
            fps: 0
        };
        
        let logBuffer = [];
        const MAX_LOGS = 100;
        
        // Override console para capturar logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            addLog('info', args.join(' '));
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            addLog('error', args.join(' '));
            debugStats.errorCount++;
            updateStats();
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            addLog('warn', args.join(' '));
            originalWarn.apply(console, args);
        };
        
        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            logBuffer.unshift({ type, message, timestamp });
            
            if (logBuffer.length > MAX_LOGS) {
                logBuffer.pop();
            }
            
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logOutput = document.getElementById('log-output');
            if (!logOutput) return;
            
            logOutput.innerHTML = logBuffer.map(log => 
                `<div class="log-entry log-${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
            
            logOutput.scrollTop = 0;
        }
        
        function updateStats() {
            document.getElementById('detection-count').textContent = debugStats.detectionCount;
            document.getElementById('face-count').textContent = debugStats.faceCount;
            document.getElementById('fps-count').textContent = debugStats.fps.toFixed(1);
            document.getElementById('error-count').textContent = debugStats.errorCount;
        }
        
        function updateSystemStatus(status, type = 'warning') {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = `<div class="status-item status-${type}">${status}</div>`;
        }
        
        function updateTechInfo(info) {
            const techDiv = document.getElementById('tech-info');
            techDiv.innerHTML = Object.entries(info).map(([key, value]) => 
                `<div><strong>${key}:</strong> ${value}</div>`
            ).join('');
        }
        
        // Fun√ß√£o customizada para detec√ß√£o com debug
        function debugDetection() {
            const now = Date.now();
            if (debugStats.lastDetectionTime > 0) {
                const deltaTime = (now - debugStats.lastDetectionTime) / 1000;
                debugStats.fps = 1 / deltaTime;
            }
            debugStats.lastDetectionTime = now;
            debugStats.detectionCount++;
            updateStats();
        }
        
        // Aguardar carregamento e inicializar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== DEBUG SYSTEM INICIADO ===');
            updateSystemStatus('Sistema de debug carregado', 'ok');
            
            setTimeout(() => {
                console.log('Verificando bibliotecas...');
                
                const hasJSMpeg = typeof JSMpeg !== 'undefined';
                const hasFaceAPI = typeof faceapi !== 'undefined';
                
                updateTechInfo({
                    'JSMpeg': hasJSMpeg ? '‚úÖ Carregado' : '‚ùå N√£o encontrado',
                    'Face-API': hasFaceAPI ? '‚úÖ Carregado' : '‚ùå N√£o encontrado',
                    'User Agent': navigator.userAgent.substring(0, 50) + '...',
                    'Timestamp': new Date().toLocaleString()
                });
                
                if (hasJSMpeg && hasFaceAPI) {
                    initializeDebugSystem();
                } else {
                    updateSystemStatus('‚ùå Bibliotecas n√£o carregadas', 'error');
                }
            }, 3000);
        });
        
        async function initializeDebugSystem() {
            try {
                console.log('Carregando modelos face-api...');
                updateSystemStatus('Carregando modelos de IA...', 'warning');
                
                await faceapi.nets.tinyFaceDetector.loadFromUri('/models/tiny_face_detector');
                console.log('‚úì Modelos carregados com sucesso!');
                
                updateSystemStatus('‚úÖ Modelos carregados - Iniciando v√≠deo', 'ok');
                initializeDebugVideo();
                
            } catch (error) {
                console.error('Erro ao carregar modelos:', error);
                updateSystemStatus('‚ùå Erro ao carregar modelos', 'error');
            }
        }
        
        function initializeDebugVideo() {
            console.log('Inicializando v√≠deo com debug...');
            
            const videoContainer = document.getElementById('video-container');
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            canvas.style.maxWidth = '100%';
            canvas.style.height = 'auto';
            
            videoContainer.appendChild(canvas);
            
            updateTechInfo({
                'Canvas': `${canvas.width}x${canvas.height}`,
                'Stream URL': 'ws://localhost:9999',
                'Status': 'Conectando...'
            });
            
            const player = new JSMpeg.Player('ws://localhost:9999', {
                canvas: canvas,
                audio: false,
                autoplay: true,
                onPlay: () => {
                    console.log('‚úÖ V√≠deo conectado e reproduzindo!');
                    updateSystemStatus('‚úÖ Sistema funcionando - Detec√ß√£o ativa', 'ok');
                    startDebugDetection(canvas);
                },
                onError: (error) => {
                    console.error('‚ùå Erro no player:', error);
                    updateSystemStatus('‚ùå Erro na conex√£o do v√≠deo', 'error');
                }
            });
            
            window.debugPlayer = player;
            window.debugCanvas = canvas;
        }
        
        async function startDebugDetection(canvas) {
            console.log('üîç Iniciando detec√ß√£o com debug...');
            
            const detect = async () => {
                try {
                    debugDetection();
                    
                    const ctx = canvas.getContext('2d');
                    if (!ctx) {
                        setTimeout(detect, 500);
                        return;
                    }
                    
                    // Verificar dados do canvas
                    let hasData = false;
                    try {
                        const imageData = ctx.getImageData(0, 0, 10, 10);
                        hasData = imageData && !imageData.data.every(val => val === 0);
                    } catch (e) {
                        setTimeout(detect, 500);
                        return;
                    }
                    
                    if (!hasData) {
                        setTimeout(detect, 500);
                        return;
                    }
                    
                    // Fazer detec√ß√£o
                    const detections = await faceapi
                        .detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions({
                            inputSize: 416,
                            scoreThreshold: 0.3
                        }));
                    
                    debugStats.faceCount = detections.length;
                    
                    if (detections.length > 0) {
                        console.log(`üéØ ${detections.length} face(s) detectada(s)!`);
                        
                        // Desenhar detec√ß√µes
                        ctx.strokeStyle = '#00ff00';
                        ctx.lineWidth = 3;
                        ctx.fillStyle = '#00ff00';
                        ctx.font = '16px Arial';
                        
                        detections.forEach((detection, index) => {
                            const { x, y, width, height } = detection.box;
                            ctx.strokeRect(x, y, width, height);
                            ctx.fillText(`Face ${index + 1}`, x, Math.max(y - 5, 15));
                        });
                        
                        addLog('success', `${detections.length} face(s) detectada(s)`);
                    }
                    
                    updateStats();
                    
                } catch (error) {
                    console.error('Erro na detec√ß√£o:', error.message);
                }
                
                setTimeout(detect, 500);
            };
            
            setTimeout(detect, 3000);
        }
    </script>
</body>
</html>
